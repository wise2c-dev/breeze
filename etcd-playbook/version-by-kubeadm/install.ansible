- name: install etcd
  hosts: etcd
  user: root
  vars:
    path: /var/tmp/wise2c/etcd
  tasks:
  - name: make etcd dir
    file:
      path: '{{ item }}'
      state: directory
      mode: 0755
    with_items:
      - '{{ path }}'

  - name: copy etcd image
    copy:
      src: '{{ item.src }}'
      dest: '{{ item.dest }}'
    with_items:
      - { src: 'file/etcd.tar.bz2', dest: '{{ path }}' }
    run_once: true

  - name: load etcd image
    docker_image:
      load_path: '{{ path }}/etcd.tar.bz2'
      name: etcd
      timeout: 600
    run_once: true

  - name: docker login
    docker_login:
      registry: '{{ registry_endpoint }}'
      username: '{{ registry_user }}'
      password: '{{ registry_password }}'
      reauthorize: true
    run_once: true

  - name: tag images
    docker_image:
      name: '{{ item.repo }}/{{ item.name }}'
      repository: '{{ registry_endpoint }}/{{ registry_project }}/{{ item.name }}'
      tag: '{{ item.tag }}'
    with_items:
      - { repo: 'k8s.gcr.io', name: 'etcd-amd64', tag: '{{ version }}' }
    run_once: true

  - name: push images
    docker_image:
      name: '{{ registry_endpoint }}/{{ registry_project }}/{{ item.name }}'
      tag: '{{ item.tag }}'
      push: true
      state: present
    with_items:
      - { repo: 'k8s.gcr.io', name: 'etcd-amd64', tag: '{{ version }}' }
    run_once: true

  - name: remove original images tag
    docker_image:
      state: absent
      name: '{{ item.repo }}/{{ item.name }}'
      tag: '{{ item.tag }}'
    with_items:
      - { repo: 'k8s.gcr.io', name: 'etcd-amd64', tag: '{{ version }}' }
    run_once: ture

  - name: run etcd
    docker_container:
      name: etcd
      network_mode: host
      restart_policy: unless-stopped
      image: "{{ registry_endpoint }}/{{ registry_project }}/etcd-amd64:{{ version }}"
      command: '{{ command }}'
      volumes:
        - "{{ etcd_data_path }}:/var/lib/etcd"
